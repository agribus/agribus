<div class="page-container">
  <tui-stepper [activeItemIndex]="step()">
    <button tuiStep type="button" [disabled]="true">
      {{ "components.greenhouse-form.step.details" | translate }}
    </button>
    <button tuiStep type="button" [disabled]="true">
      {{ "components.greenhouse-form.step.crops" | translate }}
    </button>
    <button tuiStep type="button" [disabled]="true">
      {{ "components.greenhouse-form.step.sensors" | translate }}
    </button>
  </tui-stepper>

  @switch (step()) {
    @case (0) {
      <ng-container>
        <form [formGroup]="step0">
          <tui-textfield>
            <label tuiLabel for="name">Nom de la serre</label>
            <input formControlName="name" tuiTextfield placeholder="Serre 1" />
          </tui-textfield>

          <!--          <app-location-selector formControlName="location" />-->

          <footer style="display: flex; justify-content: flex-end">
            <button tuiButton appearance="primary" (click)="next()">
              {{ "components.ui.button.next" | translate }}
            </button>
          </footer>
        </form>
      </ng-container>
    }
    @case (1) {
      <ng-container>
        <form [formGroup]="step1">
          <div class="sensor-button-group">
            <button
              tuiButton
              type="button"
              appearance="primary"
              class="compact-button"
              (click)="cropSelector.open()">
              <tui-icon icon="@tui.camera" [style.height.rem]="1" />
            </button>

            <!--            <button-->
            <!--              tuiButton-->
            <!--              type="button"-->
            <!--              appearance="primary"-->
            <!--              class="compact-button"-->
            <!--              (click)="manualAddSensor()">-->
            <!--              <tui-icon icon="@tui.keyboard" [style.height.rem]="1" />-->
            <!--            </button>-->
          </div>

          <app-crop-selector
            (cropSelected)="onCropSelected($event)"
            #cropSelector></app-crop-selector>

          <app-crop-form #cropForm [label]="'Editer un crop'"></app-crop-form>

          @if (selectedCrops.length) {
            <ul>
              @for (crop of selectedCrops; track $index) {
                <li>
                  <tui-swipe-actions
                    [style.--tui-item-size.px]="40"
                    [style.--tui-action-gap]="10"
                    [autoClose]="true">
                    <div tuiAppearance="floating" tuiCardLarge tuiCell>
                      <tui-avatar appearance="primary" [src]="crop.imageUrl" />
                      <div tuiTitle>
                        <strong>{{ crop.commonName }}</strong>
                        <div tuiSubtitle>{{ crop.scientificName }}</div>
                      </div>
                      <p style="margin: auto 0">{{ crop.quantity }}x</p>
                    </div>

                    <button
                      iconStart="@tui.pencil-line"
                      size="m"
                      tuiIconButton
                      tuiSwipeAction
                      (click)="cropForm.open()">
                      Edit Crop
                    </button>
                    <button
                      appearance="secondary-destructive"
                      iconStart="@tui.trash"
                      size="m"
                      tuiIconButton
                      tuiSwipeAction
                      type="button"
                      (click)="removeCrop($index)">
                      Delete Crop
                    </button>
                  </tui-swipe-actions>
                </li>
              }
            </ul>
          }
          <footer>
            <button tuiButton appearance="primary" (click)="previous()">
              {{ "components.ui.button.return" | translate }}
            </button>
            <button tuiButton appearance="primary" (click)="next()">
              {{ "components.ui.button.next" | translate }}
            </button>
          </footer>
        </form>
      </ng-container>
    }
    @case (2) {
      <ng-container>
        <form [formGroup]="greenhouseForm">
          <div class="sensor-button-group">
            <button
              tuiButton
              type="button"
              appearance="primary"
              class="compact-button"
              (click)="openScanQrCode()">
              <tui-icon icon="@tui.camera" [style.height.rem]="1" />
            </button>

            <button
              tuiButton
              type="button"
              appearance="primary"
              class="compact-button"
              (click)="manualAddSensor()">
              <tui-icon icon="@tui.keyboard" [style.height.rem]="1" />
            </button>
          </div>
          <div class="sensor-section-header">
            <div tuiSubtitle class="sensor-subtitle">
              Vous pouvez scanner le QR Code sur votre capteur ou saisir l'identifiant manuellement.
            </div>
          </div>
          <ul>
            @for (sensor of sensors; track $index) {
              <li>
                <tui-swipe-actions
                  [style.--tui-item-size.px]="40"
                  [style.--tui-action-gap]="10"
                  [autoClose]="true">
                  <div tuiAppearance="floating" tuiCardLarge tuiCell>
                    <tui-avatar appearance="primary" [src]="'@tui.cpu'" />
                    <div tuiTitle>
                      <strong>{{ sensor.sourceAddress }}</strong>
                      <div tuiSubtitle>{{ sensor.name }}</div>
                    </div>
                  </div>
                  <button
                    iconStart="@tui.pencil-line"
                    size="m"
                    tuiIconButton
                    tuiSwipeAction
                    (click)="sensorForm.open()">
                    Edit
                  </button>

                  <button
                    appearance="secondary-destructive"
                    iconStart="@tui.trash"
                    size="m"
                    tuiIconButton
                    tuiSwipeAction
                    type="button"
                    (click)="removeCapteur($index)">
                    Delete
                  </button>
                </tui-swipe-actions>
              </li>
              <app-sensor-form
                #sensorForm
                [sensor]="sensor"
                (sensorSubmitted)="onSensorSaved($event)"></app-sensor-form>
            }
          </ul>

          <footer>
            <button tuiButton appearance="primary" (click)="previous()">
              {{ "components.ui.button.return" | translate }}
            </button>
            <button
              tuiButton
              appearance="primary"
              (click)="next()"
              [disabled]="!isCurrentStepValid()">
              {{ "components.ui.button.next" | translate }}
            </button>
          </footer>
        </form>
      </ng-container>
    }
  }
</div>

@if (isScanning) {}
