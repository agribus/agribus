<tui-stepper [activeItemIndex]="step()">
  <button tuiStep type="button" [disabled]="true">
    {{ "components.greenhouse-form.step.details" | translate }}
  </button>
  <button tuiStep type="button" [disabled]="true">
    {{ "components.greenhouse-form.step.crops" | translate }}
  </button>
  <button tuiStep type="button" [disabled]="true">
    {{ "components.greenhouse-form.step.sensors" | translate }}
  </button>
</tui-stepper>

@switch (step()) {
  @case (0) {
    <ng-container>
      <form [formGroup]="step0">
        <tui-textfield>
          <label tuiLabel for="name">
            {{ "components.greenhouse-form.label.name" | translate }}
          </label>
          <input formControlName="name" tuiTextfield placeholder="Serre 1" />
        </tui-textfield>

        <!-- <app-location-selector formControlName="location" />-->

        <footer style="display: flex; justify-content: flex-end">
          <button tuiButton appearance="primary" (click)="next()">
            {{ "components.ui.button.next" | translate }}
          </button>
        </footer>
      </form>
    </ng-container>
  }
  @case (1) {
    <ng-container>
      <form [formGroup]="greenhouseForm">
        <div class="button-group">
          <button
            tuiButton
            type="button"
            appearance="primary"
            class="compact-button"
            (click)="openCropSelector()">
            <tui-icon icon="@tui.camera" [style.height.rem]="1" />
          </button>

          <button
            tuiButton
            type="button"
            appearance="primary"
            class="compact-button"
            (click)="openCropForm(null)">
            <tui-icon icon="@tui.keyboard" [style.height.rem]="1" />
          </button>
        </div>

        @if (crops.length) {
          <ul>
            @for (crop of crops; track $index) {
              <li>
                <tui-swipe-actions [autoClose]="true">
                  <div tuiAppearance="floating" tuiCardLarge tuiCell>
                    <tui-avatar appearance="primary" [src]="crop.imageUrl" />
                    <div tuiTitle>
                      <strong>{{ crop.commonName }}</strong>
                      <div tuiSubtitle>{{ crop.scientificName }}</div>
                    </div>
                    <p style="margin: auto 0">{{ crop.quantity }}x</p>
                  </div>

                  <button
                    iconStart="@tui.pencil-line"
                    size="m"
                    tuiIconButton
                    tuiSwipeAction
                    (click)="openCropForm(crop)">
                    Edit Crop
                  </button>
                  <button
                    appearance="secondary-destructive"
                    iconStart="@tui.trash"
                    size="m"
                    tuiIconButton
                    tuiSwipeAction
                    type="button"
                    (click)="removeCrop($index)">
                    Delete Crop
                  </button>
                </tui-swipe-actions>
              </li>
            }
          </ul>
        }

        <footer class="button-group">
          <button tuiButton appearance="primary" (click)="previous()">
            {{ "components.ui.button.return" | translate }}
          </button>
          <button tuiButton appearance="primary" (click)="next()">
            {{ "components.ui.button.next" | translate }}
          </button>
        </footer>
        <app-crop-form #cropForm [label]="'Editer un crop'"></app-crop-form>
        <app-crop-selector
          #cropSelector
          (cropSelected)="onCropSelected($event)"></app-crop-selector>
      </form>
    </ng-container>
  }
  @case (2) {
    <ng-container>
      <form [formGroup]="greenhouseForm">
        <div class="button-group">
          <button
            tuiButton
            type="button"
            appearance="primary"
            class="compact-button"
            (click)="openScanQrCode()">
            <tui-icon icon="@tui.camera" [style.height.rem]="1" />
          </button>

          <button
            tuiButton
            type="button"
            appearance="primary"
            class="compact-button"
            (click)="openSensorForm(null)">
            <tui-icon icon="@tui.keyboard" [style.height.rem]="1" />
          </button>
        </div>

        <div class="sensor-section-header">
          <div tuiSubtitle class="sensor-subtitle">
            Vous pouvez scanner le QR Code sur votre capteur ou saisir l'identifiant manuellement.
          </div>
        </div>
        <ul>
          @for (sensor of sensors; track $index) {
            <li>
              <tui-swipe-actions [autoClose]="true">
                <div tuiAppearance="floating" tuiCardLarge tuiCell>
                  <tui-avatar appearance="primary" [src]="'@tui.cpu'" />
                  <div tuiTitle>
                    <strong>{{ sensor.sourceAddress }}</strong>
                    <div tuiSubtitle>{{ sensor.name }}</div>
                  </div>
                </div>

                <button
                  iconStart="@tui.pencil-line"
                  size="m"
                  tuiIconButton
                  tuiSwipeAction
                  (click)="openSensorForm(sensor)">
                  Edit
                </button>
                <button
                  appearance="secondary-destructive"
                  iconStart="@tui.trash"
                  size="m"
                  tuiIconButton
                  tuiSwipeAction
                  type="button"
                  (click)="removeSensor($index)">
                  Delete
                </button>
              </tui-swipe-actions>
            </li>
          }
        </ul>
        @if (isScanning) {
          <app-scan-qr-code />
        }

        <app-sensor-form
          #sensorForm
          [sensor]="editingSensor"
          (sensorSubmitted)="onSensorSaved($event)"></app-sensor-form>
        <div class="btn-submit"><button size="m" tuiButton type="button">Submit</button></div>
      </form>
    </ng-container>
  }
}
