<div class="page-container">
  <tui-stepper [activeItemIndex]="step()">
    <button tuiStep type="button" [disabled]="true">
      {{ "components.greenhouse-form.step.details" | translate }}
    </button>
    <button tuiStep type="button" [disabled]="true">
      {{ "components.greenhouse-form.step.crops" | translate }}
    </button>
    <button tuiStep type="button" [disabled]="true">
      {{ "components.greenhouse-form.step.sensors" | translate }}
    </button>
  </tui-stepper>

  @switch (step()) {
    @case (0) {
      <ng-container>
        <form [formGroup]="step0">
          <tui-textfield>
            <label tuiLabel for="name">Nom de la serre</label>
            <input formControlName="name" tuiTextfield placeholder="Serre 1" />
          </tui-textfield>

          <!--          <app-location-selector formControlName="location" />-->

          <footer style="display: flex; justify-content: flex-end">
            <button tuiButton appearance="primary" (click)="next()">
              {{ "components.ui.button.next" | translate }}
            </button>
          </footer>
        </form>
      </ng-container>
    }
    @case (1) {
      <ng-container>
        <form [formGroup]="step1">
          <div class="sensor-button-group">
            <button
              tuiButton
              type="button"
              appearance="primary"
              class="compact-button"
              (click)="openScanCrop()">
              <tui-icon icon="@tui.camera" [style.height.rem]="1" />
            </button>

            <!--            <button-->
            <!--              tuiButton-->
            <!--              type="button"-->
            <!--              appearance="primary"-->
            <!--              class="compact-button"-->
            <!--              (click)="manualAddSensor()">-->
            <!--              <tui-icon icon="@tui.keyboard" [style.height.rem]="1" />-->
            <!--            </button>-->
          </div>
          @if (selectedCrops.length) {
            <ul>
              @for (crop of selectedCrops; track $index) {
                <li>
                  <tui-swipe-actions
                    [style.--tui-item-size.px]="40"
                    [style.--tui-action-gap]="10"
                    [autoClose]="true">
                    <div tuiAppearance="floating" tuiCardLarge tuiCell>
                      <tui-avatar appearance="primary" [src]="crop.imageUrl" />
                      <div tuiTitle>
                        <strong>{{ crop.commonName }}</strong>
                        <div tuiSubtitle>{{ crop.scientificName }}</div>
                      </div>
                      <p style="margin: auto 0">{{ crop.quantity }}x</p>
                    </div>
                    <button iconStart="@tui.pencil-line" size="m" tuiIconButton tuiSwipeAction>
                      Edit
                    </button>

                    <button
                      appearance="secondary-destructive"
                      iconStart="@tui.trash"
                      size="m"
                      tuiIconButton
                      tuiSwipeAction
                      type="button"
                      (click)="removeCrop($index)">
                      Delete Crop
                    </button>
                  </tui-swipe-actions>
                </li>
              }
            </ul>
          }
          <footer>
            <button tuiButton appearance="primary" (click)="previous()">
              {{ "components.ui.button.return" | translate }}
            </button>
            <button tuiButton appearance="primary" (click)="next()">
              {{ "components.ui.button.next" | translate }}
            </button>
          </footer>
        </form>
      </ng-container>
    }
    @case (2) {
      <ng-container>
        <form [formGroup]="greenhouseForm">
          <div class="sensor-button-group">
            <button
              tuiButton
              type="button"
              appearance="primary"
              class="compact-button"
              (click)="openScanQrCode()">
              <tui-icon icon="@tui.camera" [style.height.rem]="1" />
            </button>

            <button
              tuiButton
              type="button"
              appearance="primary"
              class="compact-button"
              (click)="manualAddSensor()">
              <tui-icon icon="@tui.keyboard" [style.height.rem]="1" />
            </button>
          </div>
          <div class="sensor-section-header">
            <div tuiSubtitle class="sensor-subtitle">
              Vous pouvez scanner le QR Code sur votre capteur ou saisir l'identifiant manuellement.
            </div>
          </div>
          <ul>
            @for (sensor of sensors; track $index) {
              <li>
                <tui-swipe-actions
                  [style.--tui-item-size.px]="40"
                  [style.--tui-action-gap]="10"
                  [autoClose]="true">
                  <div tuiAppearance="floating" tuiCardLarge tuiCell>
                    <tui-avatar appearance="primary" [src]="'@tui.cpu'" />
                    <div tuiTitle>
                      <strong>{{ sensor.sourceAddress }}</strong>
                      <div tuiSubtitle>{{ sensor.name }}</div>
                    </div>
                  </div>
                  <button
                    iconStart="@tui.pencil-line"
                    size="m"
                    tuiIconButton
                    tuiSwipeAction
                    (click)="onEditSensor(sensor)">
                    Edit
                  </button>

                  <button
                    appearance="secondary-destructive"
                    iconStart="@tui.trash"
                    size="m"
                    tuiIconButton
                    tuiSwipeAction
                    type="button"
                    (click)="removeCapteur($index)">
                    Delete
                  </button>
                </tui-swipe-actions>
              </li>
            }
          </ul>

          <footer>
            <button tuiButton appearance="primary" (click)="previous()">
              {{ "components.ui.button.return" | translate }}
            </button>
            <button
              tuiButton
              appearance="primary"
              (click)="next()"
              [disabled]="!isCurrentStepValid()">
              {{ "components.ui.button.next" | translate }}
            </button>
          </footer>
        </form>
      </ng-container>
    }
  }
</div>

@if (isScanning) {
  <app-scan-qr-code [formGroup]="step2" />
}

<ng-template [tuiSheetDialogOptions]="optionsSheet" [(tuiSheetDialog)]="openSheet">
  <div>
    <h2>Nous avons trouvé ces plantes :</h2>

    @if (loading) {
      <tui-loader size="m"></tui-loader>
      <p>Chargement en cours...</p>
    }
    @if (!loading && !crops.length) {
      <p>Aucune correspondance trouvée.</p>
    }

    @for (crop of crops; track $index) {
      <div>
        <div class="w-100">
          <label for="commonName{{ $index }}" class="label">Nom commun</label>
          <tui-textfield tuiChevron>
            <input tuiSelect [(ngModel)]="crop.commonName" />

            <tui-data-list-wrapper *tuiTextfieldDropdown new [items]="crop.commonNames" />
          </tui-textfield>
          <h4>{{ crop.scientificName }}</h4>
          <div>
            <progress max="100" tuiProgressBar [value]="crop.score * 100"></progress>
            <span>{{ crop.score * 100 | number: "1.0-0" }}%</span>
          </div>
          <tui-textfield>
            <label tuiLabel>Enter a quantity</label>

            <input tuiInputNumber [(ngModel)]="crop.quantity" [min]="0" [step]="1" />
          </tui-textfield>
        </div>
        <button tuiButton appearance="primary" size="m" (click)="selectCrop(crop)">
          Sélectionner ce légume
        </button>
      </div>
    }
  </div>
</ng-template>
